<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS ARCHON | Neural Workshop</title>
    
    <script src="https://www.paypal.com/sdk/js?client-id=BAAmHnd5CiEDa90TY6DIL5eA9Xp5A8uUMNaYK4_uw3AwsFuLkJzoBNoeaTCsPWDZ2yn0u1or0aXuq64C6g&components=hosted-buttons&enable-funding=venmo&currency=USD"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Share+Tech+Mono&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* --- CORE ARCHITECTURE --- */
        :root {
            /* DEFAULT DARK THEME */
            --bg: #030304; 
            --panel: rgba(18, 18, 22, 0.95); 
            --nav-bg: #050507;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4); 
            --accent-dim: rgba(99, 102, 241, 0.1);
            --success: #10b981; 
            --warning: #f59e0b; 
            --text-main: #f1f5f9;
            --text-dim: #64748b; 
            --border-color: rgba(255, 255, 255, 0.08);
            --scanline-opacity: 0.4;
            --vignette-opacity: 0.8;
            
            --font-tech: 'Share Tech Mono', monospace; 
            --font-display: 'Rajdhani', sans-serif;
            --font-main: 'Inter', sans-serif;
            --sidebar-width: 420px; 
            --nav-width: 70px;
        }

        /* LIGHT THEME OVERRIDES */
        body.light-mode {
            --bg: #e2e5e9;
            --panel: rgba(255, 255, 255, 0.95);
            --nav-bg: #f8fafc;
            --accent: #4f46e5; /* Slightly darker for contrast */
            --accent-glow: rgba(79, 70, 229, 0.2);
            --accent-dim: rgba(79, 70, 229, 0.05);
            --text-main: #1e293b;
            --text-dim: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --scanline-opacity: 0.05; /* Almost invisible in light mode */
            --vignette-opacity: 0.1;
        }

        * { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--accent) var(--bg); }
        body { background-color: var(--bg); color: var(--text-main); font-family: var(--font-main); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; }

        /* FX OVERLAYS */
        .grid-overlay { position: fixed; inset: 0; z-index: -1; background-image: linear-gradient(var(--border-color) 1px, transparent 1px), linear-gradient(90deg, var(--border-color) 1px, transparent 1px); background-size: 40px 40px; opacity: 0.1; pointer-events: none; }
        .vignette { position: fixed; inset: 0; pointer-events: none; background: radial-gradient(circle, transparent 50%, rgba(0,0,0, var(--vignette-opacity)) 100%); z-index: 1001; transition: 0.3s; }
        .crt-scanline { position: fixed; inset: 0; z-index: 999; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%); background-size: 100% 4px; pointer-events: none; opacity: var(--scanline-opacity); transition: 0.3s;}

        /* NAV */
        .primary-nav { width: var(--nav-width); background: var(--nav-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; padding: 25px 0; gap: 20px; z-index: 100; transition: background 0.3s; }
        .nav-item { width: 46px; height: 46px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); transition: 0.3s; border: 1px solid transparent; position: relative; }
        .nav-item:hover { color: var(--accent); background: var(--accent-dim); transform: scale(1.05); }
        .nav-item.active { background: var(--accent); color: #fff; box-shadow: 0 0 25px var(--accent-glow); border-color: rgba(255,255,255,0.2); }
        
        /* SIDEBARS */
        .sidebar-container { width: var(--sidebar-width); background: var(--panel); backdrop-filter: blur(20px); border-right: 1px solid var(--border-color); display: none; flex-direction: column; z-index: 90; box-shadow: 10px 0 40px rgba(0,0,0,0.1); transition: background 0.3s; }
        .sidebar-container.active { display: flex; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }

        .sidebar-header { padding: 25px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2 { margin: 0; font-family: var(--font-display); font-weight: 700; font-size: 22px; color: var(--text-main); letter-spacing: 2px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .sidebar-header h2 i { color: var(--accent); font-size: 16px; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 25px; }

        /* COMPONENTS */
        .module-box { background: rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); border-radius: 12px; padding: 18px; margin-bottom: 24px; position: relative; transition: border 0.3s; }
        body.light-mode .module-box { background: rgba(255, 255, 255, 0.5); }
        .module-box:hover { border-color: var(--accent); }
        .module-label { display: block; font-family: var(--font-tech); font-size: 11px; color: var(--text-dim); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }
        
        textarea, input { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-main); padding: 12px; font-family: var(--font-tech); font-size: 13px; border-radius: 6px; outline: none; margin-bottom: 12px; transition: 0.2s; }
        body.light-mode textarea, body.light-mode input { background: #fff; }
        textarea:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-dim); }
        
        .btn-action { width: 100%; background: var(--accent); color: white; border: none; padding: 14px; font-family: var(--font-display); font-weight: 700; font-size: 14px; letter-spacing: 1px; cursor: pointer; border-radius: 6px; transition: 0.3s; text-transform: uppercase; position: relative; overflow: hidden; }
        .btn-action:hover { filter: brightness(1.2); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4); }
        .btn-action.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-dim); }
        .btn-action.secondary:hover { border-color: var(--text-main); color: var(--text-main); background: var(--accent-dim); }

        /* CROPPER & PREVIEW */
        #crop-container { width: 100%; height: 280px; background: #050505; margin-bottom: 15px; overflow: hidden; display: none; border: 1px solid var(--accent); border-radius: 6px; }
        #crop-preview { max-width: 100%; }

        /* PROJECT LIST */
        .project-item { background: rgba(255,255,255,0.02); padding: 12px; margin-bottom: 8px; border-radius: 6px; font-size: 12px; border-left: 3px solid var(--text-dim); cursor: pointer; transition: 0.2s; }
        body.light-mode .project-item { background: rgba(0,0,0,0.02); }
        .project-item:hover { background: var(--accent-dim); border-left-color: var(--accent); padding-left: 18px; }

        /* VIEWPORT & GRID */
        .main-viewport { flex: 1; display: flex; flex-direction: column; background: radial-gradient(circle at 50% 50%, var(--bg) 0%, #000 120%); transition: background 0.3s; }
        .status-bar { height: 50px; background: var(--panel); border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; font-family: var(--font-tech); font-size: 11px; color: var(--text-dim); letter-spacing: 1px; backdrop-filter: blur(5px); }
        .content-scroll { flex: 1; overflow-y: auto; padding: 40px; }
        .art-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        
        /* CARD */
        .art-card { background: var(--panel); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; animation: fadeIn 0.5s ease; transition: 0.3s; position: relative; }
        .art-card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .art-card img { width: 100%; height: auto; display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* LOGS */
        .terminal-output { height: 120px; background: #020202; border-top: 1px solid var(--border-color); padding: 15px; font-family: var(--font-tech); font-size: 11px; color: var(--success); overflow-y: auto; line-height: 1.6; }
        
        /* AUTH SCREEN */
        #auth-layer { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; background-image: radial-gradient(circle at center, #111 0%, #000 100%); }
        .auth-box { width: 400px; padding: 40px; background: rgba(255,255,255,0.02); border: 1px solid var(--border-color); border-radius: 20px; text-align: center; backdrop-filter: blur(10px); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .auth-title { font-family: var(--font-display); color: #fff; font-size: 32px; letter-spacing: 4px; margin-bottom: 5px; text-transform: uppercase; font-weight: 700; text-shadow: 0 0 20px var(--accent-glow); }
        .auth-sub { font-family: var(--font-tech); color: var(--accent); font-size: 12px; letter-spacing: 2px; margin-bottom: 30px; opacity: 0.8; }

        /* UTILITY */
        .tk-branding { font-size: 10px; color: var(--text-dim); opacity: 0.6; font-family: var(--font-tech); }
        .tk-branding span { color: var(--accent); }
    </style>
</head>
<body>

    <div id="auth-layer">
        <div class="auth-box">
            <div class="auth-title">Nexus Archon</div>
            <div class="auth-sub">AI WORKSHOP ENVIRONMENT</div>
            
            <input type="password" id="accessCode" placeholder="ENTER ACCESS KEY" style="text-align:center; font-size:16px; letter-spacing:3px;">
            <button class="btn-action" onclick="authenticate()">Initialize Link</button>
            
            <div style="margin-top:20px; font-size:9px; color:#444;">SECURE CONNECTION REQUIRED</div>
        </div>
    </div>

    <div class="grid-overlay"></div>
    <div class="vignette"></div>
    <div class="crt-scanline"></div>

    <nav class="primary-nav">
        <div class="nav-item active" onclick="navTo('create', this)" title="Generation Studio"><i class="fa-solid fa-layer-group"></i></div>
        <div class="nav-item" onclick="navTo('vault', this)" title="Workshop & Tools"><i class="fa-solid fa-screwdriver-wrench"></i></div>
        <div class="nav-item" onclick="navTo('diag', this)" title="System Telemetry"><i class="fa-solid fa-chart-line"></i></div>
        
        <div style="flex:1;"></div>

        <div class="nav-item" onclick="toggleFullscreen()" title="Toggle Fullscreen"><i class="fa-solid fa-expand"></i></div>
        
        <div class="nav-item" onclick="toggleTheme()" title="Toggle Light/Dark"><i class="fa-solid fa-sun" id="themeIcon"></i></div>

        <div class="nav-item" onclick="navTo('settings', this)" title="System Config"><i class="fa-solid fa-gear"></i></div>
        
        <div class="nav-item" onclick="toggleAudio()" title="Toggle Audio">
            <i class="fa-solid fa-play" id="audioIcon"></i>
        </div>
    </nav>

    <aside id="side-create" class="sidebar-container active">
        <div class="sidebar-header"><h2><i class="fa-solid fa-wand-magic-sparkles"></i> Neural Studio</h2></div>
        <div class="sidebar-content">
            <div class="module-box">
                <span class="module-label"><span>Aesthetic Matrix</span> <i class="fa-solid fa-palette"></i></span>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                    <button class="btn-action secondary" style="font-size:10px; padding:8px;" onclick="applyPreset('cinematic')">CINEMA</button>
                    <button class="btn-action secondary" style="font-size:10px; padding:8px;" onclick="applyPreset('cyberpunk')">CYBER</button>
                    <button class="btn-action secondary" style="font-size:10px; padding:8px;" onclick="applyPreset('anime')">ANIME</button>
                </div>
            </div>
            
            <div class="module-box">
                <span class="module-label">
                    Positive Prompt
                    <i class="fa-solid fa-dice" style="cursor:pointer; color:var(--accent);" onclick="randomizePrompt()" title="Surprise Me"></i>
                </span>
                <textarea id="promptField" rows="4" placeholder="Describe your vision..."></textarea>
                
                <span class="module-label">Negative Constraints</span>
                <textarea id="negPromptField" rows="2" style="color:var(--text-dim);">blur, lowres, text, watermark, bad anatomy</textarea>
                
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <button class="btn-action secondary" style="width:48%;" onclick="saveProject()"><i class="fa-solid fa-floppy-disk"></i> Save</button>
                    <button class="btn-action secondary" style="width:48%;" onclick="clearFields()"><i class="fa-solid fa-trash"></i> Clear</button>
                </div>
            </div>

            <button class="btn-action" style="background: linear-gradient(90deg, var(--accent), #4f46e5);" onclick="runRender()">
                <i class="fa-solid fa-bolt"></i> Execute Render
            </button>
        </div>
        <div class="terminal-output" id="sysLog"><div>> SYSTEM READY.</div></div>
    </aside>

    <aside id="side-vault" class="sidebar-container">
        <div class="sidebar-header"><h2><i class="fa-solid fa-microchip"></i> Workshop</h2></div>
        <div class="sidebar-content">
            
            <div class="module-box" style="border-color:var(--accent);">
                <span class="module-label" style="color:var(--accent);">Neural Manipulation</span>
                <input type="file" id="workshopInput" accept="image/*" onchange="initWorkshop(this)" style="display:none;">
                <button class="btn-action secondary" onclick="document.getElementById('workshopInput').click()">Load Source Image</button>
                
                <div id="crop-container">
                    <img id="crop-preview">
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <button id="cropBtn" class="btn-action" style="display:none; font-size:10px;" onclick="executeCrop()">Finalize Crop</button>
                    <button id="identBtn" class="btn-action secondary" style="display:none; font-size:10px;" onclick="interrogateWorkshop()">Identify (CLIP)</button>
                    <button id="upscaleBtn" class="btn-action" style="display:none; grid-column: span 2; background:var(--success);" onclick="runUpscale()">
                        <i class="fa-solid fa-arrow-up-right-dots"></i> Run Neural Upscale (4x)
                    </button>
                </div>
            </div>

            <div class="module-box">
                <span class="module-label">Project Ledger (History)</span>
                <div id="projectList">
                    <div class="project-item">System Initialization...</div>
                </div>
            </div>
        </div>
        <div class="terminal-output" id="vaultLog"></div>
    </aside>

    <aside id="side-diag" class="sidebar-container">
        <div class="sidebar-header"><h2><i class="fa-solid fa-server"></i> Telemetry</h2></div>
        <div class="sidebar-content">
            <div class="module-box">
                <span class="module-label">GPU: RTX 3060 Status</span>
                <div style="font-family:var(--font-tech); font-size:12px; line-height:2; color:var(--success);">
                    CORE TEMP: <span id="valTemp">64</span>Â°C<br>
                    CORE LOAD: <span id="valLoad">12</span>%<br>
                    VRAM ALLOC: 4.8GB / 12GB<br>
                    FAN SPEED: 45% [SILENT]
                </div>
                <div style="height:4px; width:100%; background:#222; margin-top:10px; border-radius:2px;">
                    <div style="height:100%; width:40%; background:var(--success);"></div>
                </div>
            </div>
        </div>
    </aside>

    <aside id="side-settings" class="sidebar-container">
        <div class="sidebar-header"><h2><i class="fa-solid fa-sliders"></i> Configuration</h2></div>
        <div class="sidebar-content">
            
            <div class="module-box">
                <span class="module-label">External API Uplink</span>
                <div style="font-size:10px; color:var(--text-dim); margin-bottom:5px;">
                    Enter your specific Gradio URL (e.g., xxx.gradio.live) to bypass local loop.
                </div>
                <input type="text" id="apiUrlInput" placeholder="http://127.0.0.1:7860" oninput="saveApiUrl()">
                <div style="font-size:9px; color:var(--success); text-align:right;" id="apiStatus">USING LOCAL LOOP</div>
            </div>

            <div style="margin-top:auto;"></div>

            <div class="module-box" style="border-color: rgba(255,255,255,0.05);">
                <span class="module-label">Developer Contribution Node</span>
                <div style="font-size:10px; color:var(--text-dim); margin-bottom:10px;">Support T.K. Industries development.</div>
                <div id="paypal-container-U448X4TUAZ4EL"></div>
            </div>
        </div>
    </aside>

    <main class="main-viewport">
        <div class="content-scroll">
            <div id="mainGrid" class="art-grid"></div>
        </div>

        <header class="status-bar">
            <div class="tk-branding">Powered by <span>GEMINI</span> & <span>T.K. INDUSTRIES</span></div>
            <div style="display:flex; gap:20px;">
                <div>PING: <span id="pingVal">21</span>ms</div>
                <div id="clockDisplay">00:00:00</div>
            </div>
        </header>
    </main>

    <script>
        // CORE VARIABLES
        let API_BASE = localStorage.getItem("nexus_api_url") || "http://127.0.0.1:7860";
        let cropper;
        let activeCropData = "";
        
        // --- AUDIO ENGINE ---
        const bgAudio = new Audio('ambient.wav'); 
        bgAudio.loop = true; 
        bgAudio.volume = 0.4;

        function toggleAudio() {
            const btn = document.getElementById('audioIcon');
            if(bgAudio.paused) {
                bgAudio.play().catch(e => alert("Interact with page first"));
                btn.className = "fa-solid fa-pause";
                btn.style.color = "var(--success)";
            } else {
                bgAudio.pause();
                btn.className = "fa-solid fa-play";
                btn.style.color = ""; // Reset color
            }
        }

        // --- THEME ENGINE ---
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            const icon = document.getElementById('themeIcon');
            
            if(isLight) {
                icon.className = "fa-solid fa-moon";
            } else {
                icon.className = "fa-solid fa-sun";
            }
            // Save preference could go here
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- RANDOMIZER ENGINE ---
        const randomConcepts = [
            "cyberpunk street vendor raining neon lights",
            "ancient ruins overgrown with glowing alien flora",
            "astronaut meditating in a zen garden on mars",
            "steampunk mechanical owl with ruby eyes",
            "isometric view of a futuristic data center",
            "oil painting of a robot holding a flower"
        ];

        function randomizePrompt() {
            const rng = randomConcepts[Math.floor(Math.random() * randomConcepts.length)];
            document.getElementById('promptField').value = rng;
            // Visual feedback
            const btn = document.querySelector('.fa-dice');
            btn.style.transform = "rotate(180deg)";
            setTimeout(() => btn.style.transform = "rotate(0deg)", 300);
        }

        function clearFields() {
            document.getElementById('promptField').value = "";
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            // Restore API URL from storage
            const savedUrl = localStorage.getItem("nexus_api_url");
            if(savedUrl) {
                document.getElementById('apiUrlInput').value = savedUrl;
                document.getElementById('apiStatus').innerText = "CUSTOM UPLINK ACTIVE";
                document.getElementById('apiStatus').style.color = "var(--warning)";
            }
        };

        function authenticate() {
            const code = document.getElementById('accessCode').value.toUpperCase();
            // Simple hardcoded auth for demo
            if(code === "NEXUS77") {
                document.getElementById('auth-layer').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-layer').style.display = 'none';
                }, 500);
                // Attempt auto play audio on entry
                bgAudio.play().then(() => {
                    document.getElementById('audioIcon').className = "fa-solid fa-pause";
                    document.getElementById('audioIcon').style.color = "var(--success)";
                }).catch(e => {}); 

                writeLog("sysLog", "USER AUTHENTICATED. SESSION STARTED.");
            } else {
                alert("ACCESS DENIED");
            }
        }

        function navTo(p, el) {
            document.querySelectorAll('.sidebar-container').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('side-' + p).classList.add('active');
            el.classList.add('active');
        }

        // --- SETTINGS LOGIC ---
        function saveApiUrl() {
            const val = document.getElementById('apiUrlInput').value;
            if(val.length > 5) {
                API_BASE = val;
                localStorage.setItem("nexus_api_url", val);
                document.getElementById('apiStatus').innerText = "CUSTOM UPLINK SAVED";
                document.getElementById('apiStatus').style.color = "var(--accent)";
            } else {
                API_BASE = "http://127.0.0.1:7860";
                localStorage.removeItem("nexus_api_url");
                document.getElementById('apiStatus').innerText = "USING LOCAL LOOP";
                document.getElementById('apiStatus').style.color = "var(--success)";
            }
        }

        // --- WORKSHOP (CROP & UPSCALE) LOGIC ---
        function initWorkshop(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('crop-preview');
                    img.src = e.target.result;
                    
                    document.getElementById('crop-container').style.display = 'block';
                    document.getElementById('cropBtn').style.display = 'block';
                    document.getElementById('identBtn').style.display = 'block';
                    document.getElementById('upscaleBtn').style.display = 'grid'; // Enable upscale
                    
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(img, { aspectRatio: NaN, viewMode: 1, autoCropArea: 1 });
                    writeLog("vaultLog", "IMAGE LOADED INTO WORKSHOP.");
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function executeCrop() {
            if(!cropper) return;
            const canvas = cropper.getCroppedCanvas();
            activeCropData = canvas.toDataURL('image/png');
            writeLog("vaultLog", "CROP DATA BUFFERED. READY FOR USE.");
            alert("Crop secured in memory.");
        }

        async function interrogateWorkshop() {
            if(!cropper) return;
            writeLog("vaultLog", "INITIALIZING CLIP INTERROGATOR...");
            // Use cropped data if available, else full image
            const canvas = cropper.getCroppedCanvas();
            const b64 = canvas.toDataURL('image/png').split(',')[1];
            
            try {
                const res = await fetch(`${API_BASE}/sdapi/v1/interrogate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ image: b64, model: 'clip' })
                });
                const data = await res.json();
                document.getElementById('promptField').value = data.caption;
                navTo('create', document.querySelector('.primary-nav .nav-item:nth-child(1)')); // Jump to Create tab
                writeLog("sysLog", "SUBJECT IDENTIFIED. PROMPT UPDATED.");
            } catch(e) { 
                writeLog("vaultLog", "ERROR: API UNREACHABLE."); 
            }
        }

        // --- RESTORED UPSCALE LOGIC ---
        async function runUpscale() {
            if(!cropper) return;
            writeLog("vaultLog", "INITIATING 4X NEURAL UPSCALE...");
            
            const canvas = cropper.getCroppedCanvas();
            const b64 = canvas.toDataURL('image/png').split(',')[1];

            try {
                const res = await fetch(`${API_BASE}/sdapi/v1/extra-single-image`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        image: b64, 
                        upscaling_resize: 4,
                        upscaler_1: "R-ESRGAN 4x+" 
                    })
                });
                const data = await res.json();
                addArt("data:image/png;base64," + data.image, "Upscaled Result");
                writeLog("vaultLog", "UPSCALE COMPLETE. SENT TO VIEWPORT.");
            } catch(e) {
                writeLog("vaultLog", "UPSCALE FAILED. CHECK CONSOLE.");
            }
        }

        // --- RENDER LOGIC ---
        async function runRender() {
            const prompt = document.getElementById('promptField').value;
            const neg = document.getElementById('negPromptField').value;
            if(!prompt) { alert("INPUT DATA REQUIRED"); return; }

            writeLog("sysLog", "COMPILING GENERATION REQUEST...");
            
            try {
                const res = await fetch(`${API_BASE}/sdapi/v1/txt2img`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        prompt: prompt, 
                        negative_prompt: neg,
                        steps: 25, 
                        cfg_scale: 7,
                        width: 512,
                        height: 512,
                        sampler_name: "Euler a"
                    })
                });
                const data = await res.json();
                if(data.images) {
                    addArt("data:image/png;base64," + data.images[0], prompt);
                    writeLog("sysLog", "RENDER SUCCESSFUL.");
                }
            } catch(e) { 
                writeLog("sysLog", "CONNECTION LOST. VERIFY API URL."); 
            }
        }

        function addArt(src, p) {
            const card = document.createElement('div');
            card.className = 'art-card';
            // Added download button to card
            card.innerHTML = `
                <img src="${src}">
                <div style="padding:15px;">
                    <div style="font-size:10px; color:var(--accent); margin-bottom:5px;">ID: ${Math.floor(Math.random()*9999)}</div>
                    <div style="font-size:11px; color:var(--text-dim); line-height:1.4;">${p.substring(0,60)}...</div>
                    <a href="${src}" download="nexus_render.png" class="btn-action secondary" style="display:block; text-align:center; margin-top:10px; padding:8px; font-size:10px; text-decoration:none;">SAVE LOCAL</a>
                </div>`;
            document.getElementById('mainGrid').prepend(card);
        }

        // --- UTILS ---
        function saveProject() {
            const p = document.getElementById('promptField').value;
            if(!p) return;
            const list = document.getElementById('projectList');
            const item = document.createElement('div');
            item.className = 'project-item';
            item.innerText = p.substring(0, 40) + "...";
            item.onclick = () => { document.getElementById('promptField').value = p; };
            list.prepend(item);
            writeLog("sysLog", "SAVED TO LEDGER.");
        }

        function applyPreset(type) {
            const f = document.getElementById('promptField');
            if(type === 'cinematic') f.value += ", cinematic lighting, 8k, detailed, dramatic, movie concept art";
            if(type === 'cyberpunk') f.value += ", cyberpunk, neon lights, high tech, futuristic, night city, rain";
            if(type === 'anime') f.value += ", anime style, studio ghibli, vibrant colors, detailed lineart";
        }

        function writeLog(t, m) {
            const l = document.getElementById(t);
            const time = new Date().toLocaleTimeString();
            l.innerHTML += `<div><span style="opacity:0.5">[${time}]</span> ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        setInterval(() => {
            document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString();
            document.getElementById('valTemp').innerText = Math.floor(Math.random()*5 + 60);
        }, 1000);

        // PayPal Render
        try { paypal.HostedButtons({ hostedButtonId: "U448X4TUAZ4EL" }).render("#paypal-container-U448X4TUAZ4EL"); } catch(e) {}
    </script>
</body>
</html>
