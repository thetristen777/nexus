<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NEXUS ARCHON | Neural Workshop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Share+Tech+Mono&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<style>
/* --- CORE THEME --- */
:root {
    --bg:#030304;
    --panel:rgba(18,18,22,.95);
    --accent:#6366f1;
    --accent-dim:rgba(99,102,241,.12);
    --success:#10b981;
    --text-main:#f1f5f9;
    --text-dim:#64748b;
    --border:rgba(255,255,255,.08);

    --font-main:'Inter',sans-serif;
    --font-tech:'Share Tech Mono',monospace;
    --font-display:'Rajdhani',sans-serif;
}

*{box-sizing:border-box}
body{
    margin:0;
    display:flex;
    height:100vh;
    background:var(--bg);
    color:var(--text-main);
    font-family:var(--font-main);
    overflow:hidden;
}

nav{
    width:70px;
    background:#050507;
    border-right:1px solid var(--border);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px 0;
    gap:20px;
}

.nav-item{
    width:46px;height:46px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:12px;
    cursor:pointer;
    color:var(--text-dim);
}
.nav-item.active{
    background:var(--accent);
    color:#fff;
}

aside{
    width:420px;
    background:var(--panel);
    border-right:1px solid var(--border);
    display:none;
    flex-direction:column;
}
aside.active{display:flex}

.sidebar-header{
    padding:20px;
    font-family:var(--font-display);
    font-weight:700;
    border-bottom:1px solid var(--border);
}

.sidebar-content{
    padding:20px;
    overflow-y:auto;
    flex:1;
}

.module{
    border:1px solid var(--border);
    border-radius:10px;
    padding:15px;
    margin-bottom:20px;
}

textarea,input,select{
    width:100%;
    background:#000;
    border:1px solid var(--border);
    color:var(--text-main);
    padding:10px;
    margin-bottom:10px;
    font-family:var(--font-tech);
}

button{
    width:100%;
    padding:12px;
    background:var(--accent);
    color:#fff;
    border:none;
    cursor:pointer;
    font-family:var(--font-display);
    margin-top:6px;
}

.main{
    flex:1;
    display:flex;
    flex-direction:column;
}

.grid{
    padding:30px;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
    gap:20px;
    overflow-y:auto;
}

.card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:8px;
    overflow:hidden;
}
.card img{width:100%}

.card-body{padding:12px;font-size:11px}

.log{
    height:110px;
    background:#020202;
    font-family:var(--font-tech);
    font-size:11px;
    color:var(--success);
    padding:10px;
    overflow-y:auto;
}
</style>
</head>

<body>

<nav>
    <div class="nav-item active" onclick="nav('create',this)"><i class="fa fa-wand-magic"></i></div>
    <div class="nav-item" onclick="nav('vault',this)"><i class="fa fa-toolbox"></i></div>
</nav>

<aside id="create" class="active">
<div class="sidebar-header">Neural Studio</div>
<div class="sidebar-content">

<div class="module">
<textarea id="prompt" rows="4" placeholder="Prompt"></textarea>
<textarea id="neg" rows="2" placeholder="Negative prompt"></textarea>

<label style="font-size:11px">
<input type="checkbox" id="useCrop"> Use Workshop Image
</label>

<button onclick="runRender()">Execute Render</button>
</div>

</div>
<div class="log" id="syslog"></div>
</aside>

<aside id="vault">
<div class="sidebar-header">Workshop</div>
<div class="sidebar-content">

<div class="module">
<input type="file" id="imgInput" accept="image/*" hidden>
<button onclick="imgInput.click()">Load Image</button>

<div id="cropWrap" style="display:none;margin-top:10px">
<img id="cropImg" style="max-width:100%">
</div>

<button onclick="saveCrop()">Finalize Crop</button>

<select id="upscaler">
<option>R-ESRGAN 4x+</option>
<option>4x-UltraSharp</option>
<option>Latent</option>
</select>

<button onclick="runUpscale()">Run Upscale</button>
</div>

</div>
<div class="log" id="vaultlog"></div>
</aside>

<div class="main">
<div class="grid" id="grid"></div>
</div>

<script>
let API="http://127.0.0.1:7860";
let cropper, activeCrop=null;

/* ---------- IndexedDB Vault ---------- */
let db;
const DB="nexusVault", STORE="images";

indexedDB.open(DB,1).onupgradeneeded=e=>{
    e.target.result.createObjectStore(STORE,{keyPath:"id"});
};
indexedDB.open(DB,1).onsuccess=e=>{
    db=e.target.result;
    loadVault();
};

function saveVault(obj){
    const tx=db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).put(obj);
}

function loadVault(){
    const tx=db.transaction(STORE,"readonly");
    tx.objectStore(STORE).getAll().onsuccess=e=>{
        e.target.result.forEach(renderCard);
    };
}

/* ---------- UI ---------- */
function nav(id,el){
    document.querySelectorAll("aside").forEach(a=>a.classList.remove("active"));
    document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    el.classList.add("active");
}

function log(id,msg){
    const l=document.getElementById(id);
    l.innerHTML+=`<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
    l.scrollTop=l.scrollHeight;
}

/* ---------- Workshop ---------- */
imgInput.onchange=e=>{
    const r=new FileReader();
    r.onload=x=>{
        cropImg.src=x.target.result;
        cropWrap.style.display="block";
        cropper?.destroy();
        cropper=new Cropper(cropImg,{viewMode:1});
        log("vaultlog","Image loaded");
    };
    r.readAsDataURL(e.target.files[0]);
};

function saveCrop(){
    activeCrop=cropper.getCroppedCanvas().toDataURL("image/png");
    log("vaultlog","Crop buffered");
}

/* ---------- Render ---------- */
async function runRender(){
    const useCrop=useCropEl.checked && activeCrop;
    const payload={
        prompt:prompt.value,
        negative_prompt:neg.value,
        steps:25,
        cfg_scale:7,
        sampler_name:"Euler a"
    };

    let endpoint="txt2img";
    if(useCrop){
        payload.init_images=[activeCrop.split(",")[1]];
        payload.denoising_strength=.55;
        endpoint="img2img";
    }else{
        payload.width=512;
        payload.height=512;
    }

    const r=await fetch(`${API}/sdapi/v1/${endpoint}`,{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
    });
    const j=await r.json();
    const src="data:image/png;base64,"+j.images[0];
    addImage(src,prompt.value);
}

/* ---------- Upscale ---------- */
async function runUpscale(){
    const b64=activeCrop.split(",")[1];
    const r=await fetch(`${API}/sdapi/v1/extra-single-image`,{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            image:b64,
            upscaling_resize:4,
            upscaler_1:upscaler.value
        })
    });
    const j=await r.json();
    addImage("data:image/png;base64,"+j.image,"Upscaled");
}

/* ---------- Vault ---------- */
function addImage(src,prompt){
    const obj={
        id:crypto.randomUUID(),
        src,
        prompt,
        time:Date.now(),
        parent:null // ðŸ”œ version stacks ready
    };
    saveVault(obj);
    renderCard(obj);
}

function renderCard(o){
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
    <img src="${o.src}">
    <div class="card-body">
        <div>${o.prompt.slice(0,80)}</div>
        <button onclick="reuse('${o.src}')">Reuse</button>
    </div>`;
    grid.prepend(c);
}

function reuse(src){
    activeCrop=src;
    nav("create",document.querySelector(".nav-item"));
    log("syslog","Image reused for render");
}

const useCropEl=document.getElementById("useCrop");
</script>
</body>
</html>
