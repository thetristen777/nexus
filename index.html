<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS ARCHON | Neural Workshop & Motion</title>
    
    <script src="https://www.paypal.com/sdk/js?client-id=BAAmHnd5CiEDa90TY6DIL5eA9Xp5A8uUMNaYK4_uw3AwsFuLkJzoBNoeaTCsPWDZ2yn0u1or0aXuq64C6g&components=hosted-buttons&enable-funding=venmo&currency=USD"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Share+Tech+Mono&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root {
            --bg: #030304; --panel: rgba(18, 18, 22, 0.95); --nav-bg: #050507;
            --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.4); --accent-dim: rgba(99, 102, 241, 0.1);
            --success: #10b981; --warning: #f59e0b; --text-main: #f1f5f9;
            --text-dim: #64748b; --border-color: rgba(255, 255, 255, 0.08);
            --scanline-opacity: 0.4; --vignette-opacity: 0.8;
            --font-tech: 'Share Tech Mono', monospace; --font-display: 'Rajdhani', sans-serif; --font-main: 'Inter', sans-serif;
            --sidebar-width: 420px; --nav-width: 70px;
        }

        body.light-mode {
            --bg: #e2e5e9; --panel: rgba(255, 255, 255, 0.95); --nav-bg: #f8fafc;
            --accent: #4f46e5; --text-main: #1e293b; --border-color: rgba(0, 0, 0, 0.1);
            --scanline-opacity: 0.05; --vignette-opacity: 0.1;
        }

        * { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--accent) var(--bg); }
        body { background-color: var(--bg); color: var(--text-main); font-family: var(--font-main); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }

        /* Overlays */
        .grid-overlay { position: fixed; inset: 0; z-index: -1; background-image: linear-gradient(var(--border-color) 1px, transparent 1px), linear-gradient(90deg, var(--border-color) 1px, transparent 1px); background-size: 40px 40px; opacity: 0.1; pointer-events: none; }
        .vignette { position: fixed; inset: 0; pointer-events: none; background: radial-gradient(circle, transparent 50%, rgba(0,0,0, var(--vignette-opacity)) 100%); z-index: 1001; }
        .crt-scanline { position: fixed; inset: 0; z-index: 999; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%); background-size: 100% 4px; pointer-events: none; opacity: var(--scanline-opacity); }

        /* Nav & Sidebars */
        .primary-nav { width: var(--nav-width); background: var(--nav-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; padding: 25px 0; gap: 20px; z-index: 100; }
        .nav-item { width: 46px; height: 46px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); transition: 0.3s; border: 1px solid transparent; }
        .nav-item:hover { color: var(--accent); background: var(--accent-dim); }
        .nav-item.active { background: var(--accent); color: #fff; box-shadow: 0 0 25px var(--accent-glow); }
        
        .sidebar-container { width: var(--sidebar-width); background: var(--panel); backdrop-filter: blur(20px); border-right: 1px solid var(--border-color); display: none; flex-direction: column; z-index: 90; }
        .sidebar-container.active { display: flex; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }

        .sidebar-header { padding: 25px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2 { margin: 0; font-family: var(--font-display); font-weight: 700; font-size: 20px; letter-spacing: 2px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 25px; }

        /* Modules */
        .module-box { background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color); border-radius: 12px; padding: 18px; margin-bottom: 20px; transition: 0.3s; }
        .module-box:hover { border-color: var(--accent); }
        .module-label { display: block; font-family: var(--font-tech); font-size: 11px; color: var(--text-dim); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }
        
        textarea, input, select { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: var(--text-main); padding: 12px; font-family: var(--font-tech); font-size: 13px; border-radius: 6px; outline: none; margin-bottom: 10px; }
        .btn-action { width: 100%; background: var(--accent); color: white; border: none; padding: 14px; font-family: var(--font-display); font-weight: 700; font-size: 13px; cursor: pointer; border-radius: 6px; transition: 0.3s; text-transform: uppercase; }
        .btn-action:hover { filter: brightness(1.2); transform: translateY(-2px); box-shadow: 0 5px 20px var(--accent-glow); }
        .btn-action.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-dim); }

        #crop-container { width: 100%; height: 200px; background: #000; margin-bottom: 15px; display: none; border-radius: 6px; overflow: hidden; }

        /* Viewport */
        .main-viewport { flex: 1; display: flex; flex-direction: column; background: radial-gradient(circle at 50% 50%, var(--bg) 0%, #000 120%); }
        .content-scroll { flex: 1; overflow-y: auto; padding: 40px; }
        .art-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .art-card { background: var(--panel); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; transition: 0.3s; animation: fadeIn 0.5s ease; }
        .art-card img, .art-card video { width: 100%; height: auto; display: block; }

        .terminal-output { height: 110px; background: #020202; border-top: 1px solid var(--border-color); padding: 15px; font-family: var(--font-tech); font-size: 11px; color: var(--success); overflow-y: auto; }
        .status-bar { height: 45px; background: var(--panel); border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; font-family: var(--font-tech); font-size: 11px; color: var(--text-dim); }

        #auth-layer { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; background-image: radial-gradient(circle at center, #111 0%, #000 100%); }
    </style>
</head>
<body>

    <div id="auth-layer">
        <div style="text-align:center; background: rgba(255,255,255,0.02); padding: 50px; border-radius: 20px; border: 1px solid var(--border-color);">
            <div style="font-family: 'Rajdhani'; color: #fff; font-size: 32px; letter-spacing: 5px; font-weight: 700;">NEXUS ARCHON</div>
            <div style="font-family: 'Share Tech Mono'; color: var(--accent); font-size: 12px; margin-bottom: 30px;">NEURAL INTERFACE V1.2</div>
            <input type="password" id="accessCode" placeholder="ENTER ACCESS KEY" style="text-align:center; font-size:16px;">
            <button class="btn-action" onclick="authenticate()">Initialize Link</button>
        </div>
    </div>

    <div class="grid-overlay"></div>
    <div class="vignette"></div>
    <div class="crt-scanline"></div>

    <nav class="primary-nav">
        <div class="nav-item active" onclick="navTo('create', this)" title="Studio"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
        <div class="nav-item" onclick="navTo('animate', this)" title="Motion"><i class="fa-solid fa-film"></i></div>
        <div class="nav-item" onclick="navTo('vault', this)" title="Workshop"><i class="fa-solid fa-microchip"></i></div>
        <div style="flex:1;"></div>
        <div class="nav-item" onclick="toggleTheme()"><i class="fa-solid fa-sun" id="themeIcon"></i></div>
        <div class="nav-item" onclick="navTo('settings', this)"><i class="fa-solid fa-gear"></i></div>
    </nav>

    <aside id="side-create" class="sidebar-container active">
        <div class="sidebar-header"><h2><i class="fa-solid fa-layer-group"></i> Neural Studio</h2></div>
        <div class="sidebar-content">
            <div class="module-box">
                <span class="module-label">Checkpoint <i class="fa-solid fa-rotate" onclick="fetchModels()" style="cursor:pointer;"></i></span>
                <select id="modelSelect" onchange="switchModel(this.value)"><option>Loading Models...</option></select>
            </div>
            <div class="module-box">
                <span class="module-label">Prompt Matrix <i class="fa-solid fa-dice" onclick="randomizePrompt()" style="cursor:pointer;"></i></span>
                <textarea id="promptField" rows="3" placeholder="Describe the visual intent..."></textarea>
                <textarea id="negPromptField" rows="2" style="font-size:11px; color:var(--text-dim);">lowres, text, error, cropped, bad anatomy, watermark</textarea>
            </div>
            <div class="module-box">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <span class="module-label">Steps: <span id="stepVal">25</span></span>
                        <input type="range" id="stepSlider" min="1" max="50" value="25" oninput="document.getElementById('stepVal').innerText=this.value">
                    </div>
                    <div>
                        <span class="module-label">CFG: <span id="cfgVal">7</span></span>
                        <input type="range" id="cfgSlider" min="1" max="20" value="7" step="0.5" oninput="document.getElementById('cfgVal').innerText=this.value">
                    </div>
                </div>
            </div>
            <button class="btn-action" onclick="runRender()">Execute Render</button>
        </div>
        <div class="terminal-output" id="genLog">> SYSTEM READY</div>
    </aside>

    <aside id="side-animate" class="sidebar-container">
        <div class="sidebar-header"><h2><i class="fa-solid fa-video"></i> Temporal Workshop</h2></div>
        <div class="sidebar-content">
            <div class="module-box">
                <span class="module-label">Motion Intensity (Bucket) <span id="motVal">40</span></span>
                <input type="range" id="motSlider" min="1" max="255" value="40" oninput="document.getElementById('motVal').innerText=this.value">
                <span class="module-label" style="margin-top:10px;">Target FPS <span id="fpsVal">12</span></span>
                <input type="range" id="fpsSlider" min="5" max="25" value="12" oninput="document.getElementById('fpsVal').innerText=this.value">
            </div>
            <div class="module-box">
                <span class="module-label">Source Asset</span>
                <div id="animPreview" style="width:100%; height:180px; background:#000; border-radius:8px; background-size:cover; background-position:center; border: 1px solid var(--accent-dim);"></div>
                <p style="font-size:10px; color:var(--text-dim); margin-top:8px;">System will use the last generated image or workshop selection.</p>
            </div>
            <button class="btn-action" style="background: var(--success);" onclick="runAnimate()">Initialize Motion</button>
        </div>
        <div class="terminal-output" id="animLog">> MOTION ENGINE STANDBY</div>
    </aside>

    <aside id="side-vault" class="sidebar-container">
        <div class="sidebar-header"><h2><i class="fa-solid fa-microchip"></i> Workshop</h2></div>
        <div class="sidebar-content">
            <div class="module-box">
                <span class="module-label">Neural Manipulation</span>
                <input type="file" id="workshopInput" style="display:none;" onchange="initWorkshop(this)">
                <button class="btn-action secondary" onclick="document.getElementById('workshopInput').click()">Load External Image</button>
                <div id="crop-container"><img id="crop-preview"></div>
                <button id="upscaleBtn" class="btn-action" style="display:none; margin-top:10px;" onclick="runUpscale()">4x Neural Upscale</button>
            </div>
            
            <div class="module-box">
                <span class="module-label">ControlNet Configuration</span>
                <label style="font-size:11px; display:flex; gap:10px; margin-bottom:10px;">
                    <input type="checkbox" id="cnEnable" style="width:auto;"> Active ControlNet
                </label>
                <select id="cnModel">
                    <option value="control_v11p_sd15_canny">Canny Edge</option>
                    <option value="control_v11f1p_sd15_depth">Depth Map</option>
                </select>
            </div>
        </div>
        <div class="terminal-output" id="vaultLog">> WORKSHOP OFFLINE</div>
    </aside>

    <aside id="side-settings" class="sidebar-container">
        <div class="sidebar-header"><h2><i class="fa-solid fa-sliders"></i> Configuration</h2></div>
        <div class="sidebar-content">
            <div class="module-box">
                <span class="module-label">Forge API Uplink</span>
                <input type="text" id="apiUrlInput" placeholder="http://127.0.0.1:7860" oninput="saveApiUrl()">
                <div style="font-size:9px; color:var(--success); text-align:right;">UPLINK ACTIVE</div>
            </div>
            <div id="paypal-container-U448X4TUAZ4EL"></div>
        </div>
    </aside>

    <main class="main-viewport">
        <div class="content-scroll"><div id="mainGrid" class="art-grid"></div></div>
        <footer class="status-bar">
            <div class="tk-branding">Powered by <span>T.K. INDUSTRIES</span></div>
            <div style="display:flex; gap:20px;">
                <div>GPU: RTX 3060</div>
                <div id="clockDisplay">00:00:00</div>
            </div>
        </footer>
    </main>

    <script>
        let API_BASE = localStorage.getItem("nexus_api_url") || "http://127.0.0.1:7860";
        let lastImgB64 = "";
        let cropper;

        // --- Auth & Init ---
        function authenticate() {
            if(document.getElementById('accessCode').value.toUpperCase() === "NEXUS77") {
                document.getElementById('auth-layer').style.opacity = '0';
                setTimeout(() => document.getElementById('auth-layer').style.display = 'none', 500);
                fetchModels();
            }
        }

        // --- Navigation ---
        function navTo(p, el) {
            document.querySelectorAll('.sidebar-container').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('side-' + p).classList.add('active');
            el.classList.add('active');
        }

        // --- API & Core Functions ---
        async function fetchModels() {
            try {
                const res = await fetch(`${API_BASE}/sdapi/v1/sd-models`);
                const models = await res.json();
                const select = document.getElementById('modelSelect');
                select.innerHTML = models.map(m => `<option value="${m.title}">${m.model_name}</option>`).join('');
                writeLog("genLog", "MODELS SYNCHRONIZED.");
            } catch(e) { writeLog("genLog", "CONNECTION ERROR."); }
        }

        async function switchModel(title) {
            writeLog("genLog", "SWITCHING NEURAL CORE...");
            await fetch(`${API_BASE}/sdapi/v1/options`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sd_model_checkpoint: title })
            });
            writeLog("genLog", "CORE SWAP SUCCESSFUL.");
        }

        async function runRender() {
            writeLog("genLog", "RENDERING IMAGE...");
            const payload = {
                prompt: document.getElementById('promptField').value,
                negative_prompt: document.getElementById('negPromptField').value,
                steps: parseInt(document.getElementById('stepSlider').value),
                cfg_scale: parseFloat(document.getElementById('cfgSlider').value)
            };

            // ControlNet Injection if in Workshop
            if(document.getElementById('cnEnable').checked && lastImgB64) {
                payload.alwayson_scripts = { "ControlNet": { "args": [{ "input_image": lastImgB64, "model": document.getElementById('cnModel').value }] } };
            }

            try {
                const res = await fetch(`${API_BASE}/sdapi/v1/txt2img`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                lastImgB64 = data.images[0];
                addMedia("data:image/png;base64," + lastImgB64, 'image');
                document.getElementById('animPreview').style.backgroundImage = `url(data:image/png;base64,${lastImgB64})`;
                writeLog("genLog", "SUCCESS.");
            } catch(e) { writeLog("genLog", "RENDER FAILED."); }
        }

        async function runAnimate() {
            if(!lastImgB64) { writeLog("animLog", "NO SOURCE ASSET DETECTED."); return; }
            writeLog("animLog", "CONTACTING FORGE MOTION ENGINE...");
            
            try {
                const res = await fetch(`${API_BASE}/svd/image2video`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        "input_image": lastImgB64,
                        "motion_bucket_id": parseInt(document.getElementById('motSlider').value),
                        "fps": parseInt(document.getElementById('fpsSlider').value),
                        "steps": 20
                    })
                });
                const data = await res.json();
                const vData = data.video || data.images[0];
                addMedia(vData.startsWith('http') ? vData : "data:video/mp4;base64," + vData, 'video');
                writeLog("animLog", "MOTION TRANSFER SUCCESSFUL.");
            } catch(e) { writeLog("animLog", "UPLINK FAILED. CHECK SVD MODEL."); }
        }

        // --- UI & Helpers ---
        function addMedia(src, type) {
            const card = document.createElement('div');
            card.className = 'art-card';
            card.innerHTML = type === 'video' ? `<video src="${src}" controls loop autoplay></video>` : `<img src="${src}">`;
            document.getElementById('mainGrid').prepend(card);
        }

        function writeLog(id, msg) {
            const el = document.getElementById(id);
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div><span style="opacity:0.4">[${time}]</span> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function initWorkshop(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('crop-preview');
                    img.src = e.target.result;
                    document.getElementById('crop-container').style.display = 'block';
                    document.getElementById('upscaleBtn').style.display = 'block';
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(img, { viewMode: 1 });
                    lastImgB64 = e.target.result.split(',')[1];
                    document.getElementById('animPreview').style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('themeIcon');
            icon.className = document.body.classList.contains('light-mode') ? "fa-solid fa-moon" : "fa-solid fa-sun";
        }

        function saveApiUrl() { 
            API_BASE = document.getElementById('apiUrlInput').value; 
            localStorage.setItem("nexus_api_url", API_BASE); 
        }

        function randomizePrompt() {
            const prompts = ["mechanical deity, hyper-realistic, gold accents", "cyberpunk rain city, neon reflections", "alien flora bioluminescent forest"];
            document.getElementById('promptField').value = prompts[Math.floor(Math.random()*prompts.length)];
        }

        setInterval(() => { document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString(); }, 1000);
    </script>
</body>
</html>
