<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus | Archon v6.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --accent: #5d5fef; 
            --accent-glow: rgba(93, 95, 239, 0.4);
            --bg: #f4f6f9;
            --text: #2d3436;
            --sub: #636e72;
            --glass: rgba(255, 255, 255, 0.85);
        }

        body { 
            margin: 0; min-height: 100vh; background: var(--bg);
            font-family: 'Inter', sans-serif; display: flex; color: var(--text);
            overflow: hidden; /* Desktop default */
        }

        /* --- SIDEBAR (CONTROLS) --- */
        .sidebar {
            width: 380px; background: var(--glass);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-right: 1px solid rgba(255,255,255,0.6); display: flex; flex-direction: column;
            box-shadow: 10px 0 30px rgba(0,0,0,0.03); z-index: 20; height: 100vh;
        }

        .header-logo {
            padding: 30px 25px 20px 25px;
        }
        .header-logo div {
            font-family:'Quicksand'; font-size:26px; font-weight:700; color:var(--accent);
            text-shadow: 0 0 20px rgba(93, 95, 239, 0.1);
        }

        /* TABS */
        .tab-nav { display: flex; padding: 0 15px 15px 15px; gap: 8px; }
        .tab-trigger {
            flex: 1; padding: 12px; border-radius: 12px; border: none; font-family: 'Quicksand';
            font-weight: 700; font-size: 11px; background: rgba(0,0,0,0.03); cursor: pointer; color: var(--sub);
            transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tab-trigger.active { background: var(--accent); color: white; box-shadow: 0 4px 12px var(--accent-glow); }

        .tab-content { display: none; padding: 0 25px 25px 25px; overflow-y: auto; flex: 1; scrollbar-width: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUTS */
        .input-group { background: white; padding: 18px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); border: 1px solid rgba(255,255,255,0.8); }
        label { font-size: 10px; font-weight: 800; color: var(--accent); display: block; margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; }
        
        textarea, select, input { 
            width: 100%; padding: 14px; border-radius: 14px; border: 2px solid #f0f2f5; 
            background: #fafbfc; font-family: inherit; box-sizing: border-box; font-size: 14px; outline: none; transition: 0.2s;
        }
        textarea:focus, input:focus, select:focus { border-color: var(--accent); background: white; }

        .btn-main {
            font-family: 'Quicksand'; font-weight: 700; padding: 18px; border: none; border-radius: 16px;
            cursor: pointer; transition: 0.2s; background: var(--accent); color: white;
            box-shadow: 0 8px 25px var(--accent-glow); font-size: 12px; letter-spacing: 1.5px; width: 100%;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { background: #cbd5e0; cursor: wait; box-shadow: none; }

        /* --- MAIN VIEW (RESULTS) --- */
        .main-view { 
            flex: 1; height: 100vh; overflow-y: auto; 
            padding: 40px; background-image: radial-gradient(circle at 10% 10%, rgba(93, 95, 239, 0.05) 0%, transparent 40%);
            scroll-behavior: smooth; position: relative;
        }
        
        #statusIndicator { 
            display: inline-flex; align-items: center; gap: 10px;
            padding: 12px 24px; border-radius: 40px; background: white; font-family:'Quicksand'; 
            font-weight:700; color:var(--text); margin-bottom:30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.06); font-size: 12px;
        }

        .output-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; width: 100%; max-width: 1600px; padding-bottom: 100px; }
        
        .canvas-card { 
            background: white; border-radius: 24px; padding: 12px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.04); transition: transform 0.3s;
        }
        .canvas-card:hover { transform: translateY(-5px); }
        .canvas-card img { width: 100%; border-radius: 18px; display: block; margin-bottom: 12px; }

        /* SKELETON LOADER */
        .skeleton-box { 
            background: white; border-radius: 24px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            animation: pulse 2s infinite; 
        }
        .skeleton-img { width: 100%; aspect-ratio: 1/1; background: #eee; border-radius: 18px; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* LOGIN SCREEN */
        #gatekeeper { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }

        /* MOBILE OPTIMIZATION */
        @media (max-width: 850px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { width: 100%; height: auto; position: relative; border-right: none; border-bottom: 1px solid #eee; }
            .main-view { height: auto; overflow: visible; padding: 30px 20px 120px 20px; }
            .tab-trigger { padding: 15px; font-size: 12px; } /* Bigger touch targets */
            
            #scrollHelper {
                position: fixed; bottom: 20px; right: 20px; background: var(--text); color: white;
                width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
                box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 100; opacity: 0; transition: 0.3s; pointer-events: none;
            }
            #scrollHelper.visible { opacity: 1; pointer-events: all; }
        }
    </style>
</head>
<body>

    <div id="gatekeeper">
        <div style="text-align:center; width: 90%; max-width: 340px;">
            <h1 style="font-family:'Quicksand'; color:var(--accent); font-size: 48px; margin: 0 0 10px 0; letter-spacing:-2px;">NEXUS</h1>
            <p style="font-size: 11px; color: var(--sub); margin-bottom: 40px; letter-spacing: 4px; font-weight:700;">ARCHON v6.3</p>
            <input type="password" id="passKey" placeholder="ACCESS CODE" style="text-align:center; margin-bottom:20px; border-radius:16px; padding:18px; border:2px solid #f0f2f5;">
            <button class="btn-main" onclick="attemptLogin()">ENTER SYSTEM</button>
        </div>
    </div>

    <aside class="sidebar">
        <div class="header-logo">
            <div>Nexus <span style="font-weight:300; color:var(--sub);">Archon</span></div>
        </div>

        <nav class="tab-nav">
            <button class="tab-trigger active" onclick="switchTab('neural', this)">Generate</button>
            <button class="tab-trigger" onclick="switchTab('refinery', this)">Refine</button>
            <button class="tab-trigger" onclick="switchTab('archive', this)">History</button>
        </nav>

        <div id="tab-neural" class="tab-content active">
            <div class="input-group">
                <label>Aspect Ratio</label>
                <select id="aspectRatio">
                    <option value="512x512">1:1 Square</option>
                    <option value="448x800">9:16 Mobile Full</option>
                    <option value="768x512">3:2 Landscape</option>
                    <option value="512x768">2:3 Portrait</option>
                </select>
            </div>
            <div class="input-group">
                <label>Vision Prompt</label>
                <textarea id="prompt" rows="3" placeholder="Describe your imagination..."></textarea>
                <label style="margin-top:15px;">Style Filter</label>
                <select id="stylePreset">
                    <option value="">No Filter (Raw)</option>
                    <option value=", cyberpunk, neon lights, 8k, detailed">Cyberpunk</option>
                    <option value=", anime style, studio ghibli, vibrant">Anime / Ghibli</option>
                    <option value=", photorealistic, 35mm film, grain, 8k">Realism</option>
                    <option value=", oil painting, impasto, claude monet">Oil Painting</option>
                </select>
            </div>
            <div class="input-group" style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><label>Count</label><input type="number" id="batchSize" value="1" min="1" max="4"></div>
                <div><label>Hi-Res</label><select id="hires"><option value="false">Off</option><option value="true">On (2x)</option></select></div>
            </div>
            
            <div style="height: 6px; background:#eee; border-radius:10px; overflow:hidden; margin-bottom:15px; display:none;" id="progContainer">
                <div id="progressBar" style="width:0%; height:100%; background:var(--accent); transition: width 0.3s;"></div>
            </div>
            
            <button class="btn-main" id="genBtn" onclick="runGeneration('txt2img')">SYNTHESIZE</button>
        </div>

        <div id="tab-refinery" class="tab-content">
            <div class="input-group">
                <label>Upload Source</label>
                <input type="file" id="fileIn" accept="image/*" onchange="loadPreview(this)">
            </div>
            <div class="input-group">
                <label>Transformation Strength</label>
                <input type="range" id="denoising" min="0" max="1" step="0.05" value="0.65">
                <div style="font-size:10px; color:var(--sub); text-align:right; margin-top:5px;">Lower = Closer to original</div>
            </div>
            <button class="btn-main" onclick="runGeneration('img2img')">TRANSFORM</button>
        </div>

        <div id="tab-archive" class="tab-content">
            <div id="historyGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
            <button class="btn-main" style="margin-top:20px; background:#eee; color:#555; box-shadow:none;" onclick="clearHistory()">CLEAR HISTORY</button>
        </div>
    </aside>

    <main class="main-view" id="mainView">
        <div id="statusIndicator">ðŸŸ¢ SYSTEM READY</div>
        <div id="outputGrid" class="output-grid"></div>
    </main>

    <div id="scrollHelper" onclick="window.scrollTo({top:0, behavior:'smooth'})">â–²</div>

    <script>
        const API_URL = "https://3f115e20cf09132213.gradio.live"; // CHECK THIS IS CURRENT
        let currentImageB64 = ""; 
        let history = [];
        let isWorking = false;
        let checkInterval;

        // --- AUTH SYSTEM (With Memory) ---
        window.onload = () => {
            if(localStorage.getItem('nexus_auth') === 'granted') {
                document.getElementById('gatekeeper').style.display = 'none';
            }
        };

        function attemptLogin() {
            const val = document.getElementById('passKey').value.toUpperCase();
            if(val === "NEXUS77") {
                localStorage.setItem('nexus_auth', 'granted');
                const gate = document.getElementById('gatekeeper');
                gate.style.opacity = '0';
                setTimeout(() => gate.style.display = 'none', 500);
            } else {
                alert("ACCESS DENIED");
            }
        }

        // --- UI FUNCTIONS ---
        function switchTab(tabName, btn) {
            document.querySelectorAll('.tab-trigger').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function loadPreview(input) {
            const reader = new FileReader();
            reader.onload = e => currentImageB64 = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }

        // --- CORE GENERATION LOGIC ---
        async function runGeneration(mode) {
            if(isWorking) return;
            isWorking = true;
            
            const btn = document.getElementById('genBtn');
            const status = document.getElementById('statusIndicator');
            const grid = document.getElementById('outputGrid');
            const progBar = document.getElementById('progressBar');
            const progCont = document.getElementById('progContainer');

            // 1. UI Updates
            btn.disabled = true;
            btn.innerText = "PROCESSING...";
            progCont.style.display = 'block';
            
            // 2. MOBILE FIX: Scroll to results immediately
            if(window.innerWidth < 850) {
                document.getElementById('mainView').scrollIntoView({behavior: 'smooth'});
            }

            // 3. Setup Skeleton
            grid.innerHTML = `<div class="skeleton-box"><div class="skeleton-img"></div></div>`;
            status.innerHTML = `ðŸŸ¡ INITIALIZING NEURAL NET...`;

            // 4. Build Payload
            const [w, h] = document.getElementById('aspectRatio').value.split('x');
            let payload = {
                prompt: document.getElementById('prompt').value + document.getElementById('stylePreset').value,
                steps: 25,
                batch_size: parseInt(document.getElementById('batchSize').value),
                width: parseInt(w), height: parseInt(h),
                enable_hr: document.getElementById('hires').value === "true",
                hr_scale: 2, hr_upscaler: "Latent"
            };

            if(mode === 'img2img') {
                if(!currentImageB64) { alert("Please upload an image first!"); resetUI(); return; }
                payload.init_images = [currentImageB64.split(',')[1]];
                payload.denoising_strength = parseFloat(document.getElementById('denoising').value);
            }

            // 5. Start Polling Loop
            checkInterval = setInterval(async () => {
                try {
                    const res = await fetch(API_URL + "/sdapi/v1/progress");
                    const data = await res.json();
                    const pct = Math.round(data.progress * 100);
                    progBar.style.width = pct + "%";
                    status.innerText = `ðŸŸ¡ SYNTHESIZING: ${pct}%`;
                    
                    // Live Preview in Skeleton
                    if(data.current_image) {
                        const skel = document.querySelector('.skeleton-box');
                        if(skel) skel.innerHTML = `<img src="data:image/png;base64,${data.current_image}" style="width:100%; border-radius:18px; filter:blur(5px);">`;
                    }
                } catch(e) {}
            }, 800);

            // 6. Send Request
            try {
                const response = await fetch(API_URL + (mode === 'txt2img' ? "/sdapi/v1/txt2img" : "/sdapi/v1/img2img"), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                clearInterval(checkInterval);
                grid.innerHTML = ""; // Clear skeletons

                data.images.forEach(img => {
                    const src = "data:image/png;base64," + img;
                    const card = document.createElement('div');
                    card.className = "canvas-card";
                    card.innerHTML = `
                        <img src="${src}">
                        <div style="display:flex; gap:10px;">
                            <button class="btn-main" style="padding:10px; font-size:10px;" onclick="downloadImg('${src}')">SAVE</button>
                            <button class="btn-main" style="padding:10px; font-size:10px; background:#f0f2f5; color:#333; box-shadow:none;" onclick="useAsRefine('${src}')">REFINE âžœ</button>
                        </div>
                    `;
                    grid.appendChild(card);
                    saveToHistory(src);
                });

                status.innerHTML = `ðŸŸ¢ GENERATION COMPLETE <span style="font-size:10px; opacity:0.6;">| IDLE</span>`;

            } catch(e) {
                console.error(e);
                status.innerText = "ðŸ”´ ERROR: CONNECTION LOST";
                alert("Connection failed. Check your API URL.");
            } finally {
                resetUI();
            }
        }

        function resetUI() {
            isWorking = false;
            clearInterval(checkInterval);
            document.getElementById('genBtn').disabled = false;
            document.getElementById('genBtn').innerText = "SYNTHESIZE";
            document.getElementById('progContainer').style.display = 'none';
            document.getElementById('progressBar').style.width = "0%";
        }

        // --- HISTORY & UTILS ---
        function saveToHistory(src) {
            history.unshift(src);
            updateHistoryGrid();
        }

        function updateHistoryGrid() {
            const grid = document.getElementById('historyGrid');
            grid.innerHTML = history.slice(0, 10).map(src => 
                `<img src="${src}" style="width:100%; border-radius:10px; cursor:pointer;" onclick="restoreToMain('${src}')">`
            ).join('');
        }

        function restoreToMain(src) {
            document.getElementById('outputGrid').innerHTML = `<div class="canvas-card"><img src="${src}"></div>`;
            // Scroll to view on mobile
            if(window.innerWidth < 850) document.getElementById('mainView').scrollIntoView({behavior: 'smooth'});
        }

        function useAsRefine(src) {
            currentImageB64 = src;
            switchTab('refinery', document.querySelectorAll('.tab-trigger')[1]);
            alert("Image sent to Refine tab!");
        }

        function clearHistory() { history = []; updateHistoryGrid(); }
        function downloadImg(src) { const a = document.createElement('a'); a.href = src; a.download = `nexus_${Date.now()}.png`; a.click(); }

        // Mobile Scroll Helper visibility
        window.addEventListener('scroll', () => {
            const helper = document.getElementById('scrollHelper');
            if(window.scrollY > 300) helper.classList.add('visible');
            else helper.classList.remove('visible');
        });
    </script>
</body>
</html>
